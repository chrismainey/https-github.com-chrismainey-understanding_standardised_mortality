# Import simluated cusum data for an aggregated chart(agg) and person-level (pers)
cusum_agg <- tibble::tribble(
         ~Date,   ~Wt,  ~Ct, ~Trigger,
  "01/01/2018",   0.2,  0.2,       0L,
  "01/02/2018",    -1,    0,       0L,
  "01/03/2018",  0.25, 0.25,       0L,
  "01/04/2018",    -1,    0,       0L,
  "01/05/2018",    -1,    0,       0L,
  "01/06/2018", -0.42,    0,       0L,
  "01/07/2018",     1,    1,       0L,
  "01/08/2018",   0.5,  1.5,       0L,
  "01/09/2018",  0.75, 2.25,       0L,
  "01/10/2018",  -0.8, 1.45,       0L,
  "01/11/2018",  -0.2, 1.25,       0L,
  "01/12/2018",   1.2, 2.45,       0L,
  "01/01/2019",   0.5, 2.95,       0L,
  "01/02/2019",   1.4, 4.35,       0L,
  "01/03/2019",  -0.5, 3.85,       0L,
  "01/04/2019",  1.25,  5.1,       0L,
  "01/05/2019",   0.5,  5.6,       1L,
  "01/06/2019",   0.2,  0.2,       0L,
  "01/07/2019",   0.5,  0.7,       0L,
  "01/08/2019",   1.5,  2.2,       0L,
  "01/09/2019",  -0.6,  1.6,       0L,
  "01/10/2019",    -1,  0.6,       0L,
  "01/11/2019", -0.65,    0,       0L,
  "01/12/2019",     0,    0,       0L
  )


cusum_pres<-
  tibble::tribble(
  ~Patient, ~Died, ~Risk,          ~Wt,         ~Ct, ~Trigger,
        1L,    0L,   0.2, -0.182321557,           0,       0L,
        2L,    0L,  0.22, -0.198850859,           0,       0L,
        3L,    0L,   0.1,  -0.09531018,           0,       0L,
        4L,    0L,  0.13, -0.122217633,           0,       0L,
        5L,    1L,  0.05,  0.644357016, 0.644357016,       0L,
        6L,    0L,  0.25, -0.223143551, 0.421213465,       0L,
        7L,    1L,   0.3,  0.430782916, 0.851996381,       0L,
        8L,    0L,   0.1,  -0.09531018, 0.756686201,       0L,
        9L,    0L,  0.05, -0.048790164, 0.707896037,       0L,
       10L,    1L,  0.32,  0.415515444, 1.123411481,       0L,
       11L,    1L,   0.2,  0.510825624, 1.634237105,       0L,
       12L,    0L,   0.1,  -0.09531018, 1.538926925,       0L,
       13L,    0L,  0.12, -0.113328685,  1.42559824,       0L,
       14L,    1L,  0.04,  0.653926467, 2.079524707,       0L,
       15L,    0L,  0.35, -0.300104592, 1.779420115,       0L,
       16L,    0L,  0.24,  -0.21511138, 1.564308735,       0L,
       17L,    0L,  0.16, -0.148420005,  1.41588873,       0L,
       18L,    0L,  0.45, -0.371563556, 1.044325174,       0L,
       19L,    0L,  0.02, -0.019802627, 1.024522546,       0L,
       20L,    1L,   0.5,  0.287682072, 1.312204619,       0L,
       21L,    0L,  0.21,  -0.19062036, 1.121584259,       0L,
       22L,    1L,   0.6,  0.223143551,  1.34472781,       0L,
       23L,    0L,   0.6, -0.470003629, 0.874724181,       0L,
       24L,    1L,   0.1,  0.597837001, 1.472561182,       0L,
       25L,    0L,   0.5, -0.405465108, 1.067096074,       0L,
       26L,    0L,  0.23, -0.207014169, 0.860081904,       0L,
       27L,    0L,  0.02, -0.019802627, 0.840279277,       0L,
       28L,    1L,  0.65,  0.192371893,  1.03265117,       0L,
       29L,    0L,  0.35, -0.300104592, 0.732546577,       0L,
       30L,    0L,  0.12, -0.113328685, 0.619217892,       0L,
       31L,    0L,  0.28, -0.246860078, 0.372357814,       0L,
       32L,    1L,   0.1,  0.597837001, 0.970194815,       0L,
       33L,    1L,  0.15,  0.553385238, 1.523580053,       0L,
       34L,    1L,  0.45,  0.321583624, 1.845163677,       0L,
       35L,    1L,  0.63,  0.204567166, 2.049730843,       0L,
       36L,    0L,   0.4, -0.336472237, 1.713258606,       0L,
       37L,    1L,  0.32,  0.415515444,  2.12877405,       0L,
       38L,    0L,   0.5, -0.405465108, 1.723308942,       0L,
       39L,    1L,  0.65,  0.192371893, 1.915680835,       0L,
       40L,    0L,  0.05, -0.048790164, 1.866890671,       0L,
       41L,    0L,   0.2, -0.182321557, 1.684569114,       0L,
       42L,    0L,  0.22, -0.198850859, 1.485718255,       0L,
       43L,    0L,   0.1,  -0.09531018, 1.390408075,       0L,
       44L,    1L,  0.13,  0.570929548, 1.961337623,       0L,
       45L,    1L,  0.05,  0.644357016,  2.60569464,       0L,
       46L,    1L,  0.25,  0.470003629, 3.075698269,       0L,
       47L,    1L,   0.3,  0.430782916, 3.506481185,       0L,
       48L,    0L,   0.1,  -0.09531018, 3.411171005,       0L,
       49L,    1L,  0.05,  0.644357016, 4.055528021,       0L,
       50L,    1L,  0.32,  0.415515444, 4.471043465,       0L,
       51L,    1L,   0.2,  0.510825624, 4.981869089,       0L,
       52L,    0L,   0.1,  -0.09531018, 4.886558909,       0L,
       53L,    0L,  0.12, -0.113328685, 4.773230224,       0L,
       54L,    1L,  0.04,  0.653926467, 5.427156691,       0L,
       55L,    0L,  0.35, -0.300104592, 5.127052099,       0L,
       56L,    0L,  0.24,  -0.21511138, 4.911940719,       0L,
       57L,    0L,  0.16, -0.148420005, 4.763520714,       0L,
       58L,    0L,  0.45, -0.371563556, 4.391957158,       0L,
       59L,    1L,  0.02,  0.673344553, 5.065301711,       0L,
       60L,    1L,   0.5,  0.287682072, 5.352983784,       0L,
       61L,    0L,  0.21,  -0.19062036, 5.162363424,       0L,
       62L,    1L,   0.6,  0.223143551, 5.385506975,       0L,
       63L,    0L,   0.6, -0.470003629, 4.915503346,       0L,
       64L,    1L,   0.1,  0.597837001, 5.513340347,       0L,
       65L,    0L,   0.5, -0.405465108, 5.107875239,       0L,
       66L,    0L,  0.23, -0.207014169, 4.900861069,       0L,
       67L,    0L,  0.02, -0.019802627, 4.881058442,       0L,
       68L,    0L,  0.65, -0.500775288, 4.380283154,       0L,
       69L,    1L,  0.35,  0.393042588, 4.773325742,       0L,
       70L,    1L,  0.12,  0.579818495, 5.353144237,       0L,
       71L,    1L,  0.28,  0.446287103,  5.79943134,       0L,
       72L,    1L,   0.1,  0.597837001, 6.397268341,       1L,
       73L,    0L,  0.15, -0.139761942, 3.752019409,       0L,
       74L,    1L,  0.45,  0.321583624, 4.073603033,       0L,
       75L,    0L,  0.63, -0.488580015, 3.585023018,       0L,
       76L,    0L,   0.4, -0.336472237, 3.248550782,       0L,
       77L,    1L,  0.32,  0.415515444, 3.664066226,       0L,
       78L,    0L,   0.5, -0.405465108, 3.258601118,       0L,
       79L,    0L,  0.65, -0.500775288,  2.75782583,       0L,
       80L,    0L,  0.25, -0.223143551, 2.534682278,       0L,
       81L,    0L,   0.2, -0.182321557, 2.352360722,       0L,
       82L,    0L,  0.32, -0.277631737, 2.074728985,       0L,
       83L,    0L,   0.3, -0.262364264,  1.81236472,       0L,
       84L,    1L,  0.55,   0.25489225,  2.06725697,       0L,
       85L,    0L,   0.2, -0.182321557, 1.884935413,       0L,
       86L,    0L,  0.35, -0.300104592, 1.584830821,       0L,
       87L,    1L,  0.45,  0.321583624, 1.906414445,       0L,
       88L,    0L,     0,            0, 1.906414445,       0L,
       89L,    0L,  0.55, -0.438254931, 1.468159514,       0L,
       90L,    0L,  0.33, -0.285178942, 1.182980572,       0L,
       91L,    0L,  0.42, -0.350656872,   0.8323237,       0L,
       92L,    0L,  0.25, -0.223143551, 0.609180149,       0L,
       93L,    0L,   0.5, -0.405465108, 0.203715041,       0L,
       94L,    1L,  0.65,  0.192371893, 0.396086933,       0L,
       95L,    0L,  0.25, -0.223143551, 0.172943382,       0L,
       96L,    0L,  0.45, -0.371563556,           0,       0L,
       97L,    0L,  0.36,   -0.3074847,           0,       0L,
       98L,    0L,  0.32, -0.277631737,           0,       0L,
       99L,    0L,  0.42, -0.350656872,           0,       0L,
      100L,    0L,  0.25, -0.223143551,           0,       0L
  )



library(lubridate)
cusum_agg$Period <- factor(cusum_agg$Date)
cusum_agg$Date<-as.POSIXct(cusum_agg[[1]], format="%d/%m/%Y")


#cusum_agg[[1]]<-NULL

# cusum_pres$Patient<-cusum_pres[[1]]
# cusum_pres[1]<-NULL

cusum_agg$Trigger_n <-as.double(cusum_agg$Trigger)
cusum_agg$Trigger <-as.factor(cusum_agg$Trigger)


cusum_pres$Trigger_n <-as.double(cusum_pres$Trigger)
cusum_pres$Trigger <-as.factor(cusum_pres$Trigger)


cusum_agg$rowno <-as.integer(row.names(cusum_agg))

library(ggplot2)
library(gganimate)


# Plot aggregate CUSUM
a<- ggplot(cusum_agg, aes(x=Date, y=Ct))+
  geom_path(col="#51E85E", size=1)+
  geom_point(aes(group=seq_along(Period), shape=Trigger, size=Trigger_n, col=Trigger), fill="#51E85E")+
  geom_hline(aes(yintercept=5.48), col="goldenrod", linetype=2, size=1)+
  ggtitle("Aggreagate Cusum Example")+
  scale_size_continuous(c(0,3))+
  scale_shape_manual(values=c(16,4))+
  scale_colour_manual(values=c("#51E85E",2))+
  scale_y_continuous(name="CUSUM value",limits=c(0,6), breaks = seq(6))+
  scale_x_datetime(name="Date", breaks = "2 month", date_labels = "%b-%y")+
  guides(size = "none")  +
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45, hjust = 1),
        legend.position = "bottom")+
  transition_reveal(rowno)+
  ease_aes(default = "linear")


animate(a, height = 200, width = 400)
anim_save("agg_cusum.gif")


#Plot person-level CUSUM
b <- ggplot(cusum_pres, aes(x=Patient, y=Ct))+
  geom_path(col="dodgerblue2", size=1)+
  geom_point(aes(group=seq_along(Patient),shape=Trigger, size=Trigger_n, col=Trigger)
             , fill="#51E85E")+
  geom_hline(aes(yintercept=6.3), col="goldenrod", linetype=2, size=1)+
  ggtitle("Person-level Cusum Example")+
  scale_size_continuous(c(0,3))+
  scale_shape_manual(values=c(16,4))+
  scale_colour_manual(values=c("dodgerblue2",2))+
  scale_y_continuous(name="CUSUM value",limits=c(0,7), breaks = seq(6))+
  scale_x_continuous(breaks=seq(10,100,10))+
  guides(size = "none")+
  theme_minimal()+
  theme(legend.position = "bottom")+
  transition_reveal(Patient)+
  ease_aes(default = "linear")

animate(b, height = 200, width = 400)
anim_save("person_cusum.gif")
